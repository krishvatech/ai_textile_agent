{% extends "_dashboard_base.html" %}
{% block title %}Chat — Customer #{{ customer_id }}{% endblock %}
{% block nav_cust %}active{% endblock %}

{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Chat with Customer #{{ customer_id }}</h3>
    <a class="btn btn-outline-light" href="/dashboard/customer/{{ customer_id }}">
      <i class="bi bi-arrow-left-short"></i> Back
    </a>
  </div>

  {% if session %}
    <div class="mb-2 small text-secondary">
      Session #{{ session.id }} · Started {{ session.started_at }}{% if session.ended_at %} · Ended {{ session.ended_at }}{% endif %}
    </div>
  {% endif %}

  <div class="chat-box glass">
    <div id="chatScroll" class="chat-thread">
      {% if messages and messages|length %}
        {% for m in messages %}
          {# Stable DOM id (fallback to index if msg_id missing) #}
          {% set _id = m.msg_id if m.msg_id is defined else ('idx-' ~ loop.index0) %}
          {% set dom_id = 'msg-' ~ _id|string|replace(':','-')|replace('.','-') %}

          {% set is_in = (m.direction == 'in') %}
          {% set same_sender = (not loop.first and loop.previtem.role == m.role and loop.previtem.direction == m.direction) %}

          <div id="{{ dom_id }}" class="chat-row {{ 'in' if is_in else 'out' }}">
            {% if not same_sender %}
              <div class="avatar {{ 'avatar-us' if is_in else 'avatar-bot' }}">
                {{ 'US' if is_in else 'BO' }}
              </div>
            {% else %}
              <div class="avatar-spacer"></div>
            {% endif %}

            <div class="bubble-group">
              {# --------- IMAGE SOURCE (per side) ---------
                 - User (in): use backend-provided Meta proxy at m.meta.resolved_image
                 - Assistant (out): use DB fields (image_url / image.url / image string)
              #}
              {% if is_in %}
                {% set imgurl = m.meta.resolved_image if m.meta and m.meta.resolved_image else None %}
              {% else %}
                {% if m.meta %}
                  {% if m.meta.image_url %}
                    {% set imgurl = m.meta.image_url %}
                  {% elif m.meta.image and m.meta.image.url %}
                    {% set imgurl = m.meta.image.url %}
                  {% elif m.meta.image is string %}
                    {% set imgurl = m.meta.image %}
                  {% else %}
                    {% set imgurl = None %}
                  {% endif %}
                {% else %}
                  {% set imgurl = None %}
                {% endif %}
              {% endif %}
              {% set has_img = imgurl is not none %}

              <div class="bubble {{ 'photo' if has_img else '' }}">
                {# ---------- Reply preview (tap to jump) ---------- #}
                {% if m.meta and m.meta.reply_to %}
                  {% set replied = (messages | selectattr("msg_id","equalto", m.meta.reply_to) | list) %}
                  {% if replied and replied[0] %}
                    {% set r = replied[0] %}
                    {% set r_id = 'msg-' ~ (r.msg_id if r.msg_id is defined else ('idx-' ~ loop.index0))|replace(':','-')|replace('.','-') %}
                    {# Preview image uses same side-specific logic #}
                    {% if r.direction == 'in' %}
                      {% set r_thumb = r.meta.resolved_image if r.meta and r.meta.resolved_image else None %}
                    {% else %}
                      {% if r.meta %}
                        {% if r.meta.image_url %}
                          {% set r_thumb = r.meta.image_url %}
                        {% elif r.meta.image and r.meta.image.url %}
                          {% set r_thumb = r.meta.image.url %}
                        {% elif r.meta.image is string %}
                          {% set r_thumb = r.meta.image %}
                        {% else %}
                          {% set r_thumb = None %}
                        {% endif %}
                      {% else %}
                        {% set r_thumb = None %}
                      {% endif %}
                    {% endif %}

                    <a href="#{{ r_id }}" class="reply-preview" data-target="{{ r_id }}">
                      <div class="rp-author">{{ 'You' if r.direction == 'in' else 'Assistant' }}</div>
                      <div class="rp-row">
                        {% if r_thumb %}
                          <img class="rp-thumb" src="{{ r_thumb }}" alt="preview" referrerpolicy="no-referrer">
                        {% endif %}
                        <div class="rp-text">
                          {{ (r.text or '')[:120] }}{% if r.text and r.text|length > 120 %}…{% endif %}
                        </div>
                      </div>
                    </a>
                  {% endif %}
                {% endif %}

                {# ---------- Actual message content ---------- #}
                <div class="bubble-inner {{ 'has-img' if has_img else '' }}">
                  {% if has_img %}
                    <img src="{{ imgurl }}" alt="shared image" class="msg-img" loading="lazy" referrerpolicy="no-referrer" />
                  {% endif %}

                  {# Hide long WA link text if we rendered its image #}
                  {% set text_lower = (m.text or '')|lower %}
                  {% set hide_media_link = has_img and ('lookaside.fbsbx.com' in text_lower or 'graph.facebook.com' in text_lower) %}

                  {% if m.text and m.text|trim and not hide_media_link %}
                    <div class="{{ 'caption' if m.direction == 'out' else '' }}">
                      {{ m.text
                         | replace('\\n','\n')
                         | replace('&lt;br&gt;','\n')
                         | replace('<br>','\n')
                         | urlize(40, true)
                         | safe
                      }}
                    </div>
                  {% endif %}
                </div>
              </div>

              {% set next_sender = (not loop.last and loop.nextitem.role == m.role and loop.nextitem.direction == m.direction) %}
              {% if loop.last or not next_sender %}
                <div class="meta">
                  <span>{{ 'User' if is_in else 'Assistant' }}</span>
                  {% if m.ts %}<span class="ts">{{ m.ts }}</span>{% endif %}
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="text-secondary">No chat messages found.</div>
      {% endif %}
    </div>
  </div>

  <script>
    // Smooth scroll + highlight for reply-preview links
    document.addEventListener('DOMContentLoaded', function () {
      const thread = document.getElementById('chatScroll');

      function scrollToMessage(target) {
        if (!target) return;
        if (thread && thread.contains(target)) {
          const top = target.offsetTop - thread.offsetTop - 60;
          thread.scrollTo({ top, behavior: 'smooth' });
        } else {
          target.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        target.classList.add('ping');
        setTimeout(() => target.classList.remove('ping'), 1600);
      }

      document.addEventListener('click', function (e) {
        const link = e.target.closest('a.reply-preview');
        if (!link) return;

        const id = link.getAttribute('data-target') || (link.hash ? link.hash.slice(1) : null);
        if (!id) return;
        const target = document.getElementById(id);
        if (!target) return;

        e.preventDefault();
        scrollToMessage(target);
        history.replaceState(null, '', `#${id}`);
      });
    });
  </script>
{% endblock %}
