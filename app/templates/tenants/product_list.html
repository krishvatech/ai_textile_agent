{% extends "_dashboard_base.html" %}
{% block title %}Products{% endblock %}
{% block nav_prod %}active{% endblock %}
{% block content %}
<style>
  .prod-cell { display:flex; align-items:center; gap:.75rem; }
  .prod-thumb {
    height:100px; max-width: 75px; border-radius:10px; object-fit:cover;
    background: var(--card); border:1px solid var(--border);
  }
  .prod-thumb.placeholder {
    display:flex; align-items:center; justify-content:center; 
    font-size:18px; color:var(--muted);
  }
</style>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Products</h3>
    <a class="btn btn-outline-light" href="/dashboard/product/add">
      <i class="bi bi-plus"></i> Add Products
    </a>
    {% if request.query_params.get('updated') %}
  <div class="alert alert-success" role="alert" style="margin-top:10px">
    Product updated successfully.
  </div>
    {% endif %}

  </div>

  <!-- Tabs: JS-only filter (no navigation) -->
  <div class="mb-3">
    <div class="category-tabs" id="jsProductTabs">
      <a class="seg is-active" data-filter="all"  href="#"><i class="bi bi-grid-3x3-gap"></i> All</a>
      <a class="seg"          data-filter="sell" href="#"><i class="bi bi-bag"></i> Sell</a>
      <a class="seg"          data-filter="rent" href="#"><i class="bi bi-calendar2-week"></i> Rent</a>
    </div>
  </div>

  <div class="table-responsive">
    <table class="table-products w-100">
      <thead>
        <tr>
          <th>No</th>
          <th>Product</th>
          <th>Product Name</th>
          <th >Counts</th>
          <th>View Variants</th>
          <th>Status</th>
          <th>Modify Variants</th>
          <th>Modify Product</th>
          <th>Remove</th>
        </tr>
      </thead>
      <tbody>
  {% if products|length == 0 %}
    <!-- unchanged empty state -->
  {% else %}
    {% for p in products %}
      <tr
        data-has-sell="{{ 1 if p.sell_count>0 else 0 }}"
        data-has-rent="{{ 1 if p.rental_count>0 else 0 }}"
      >
        <td><strong>{{ loop.index }}</strong></td>

        <!-- Product cell with image -->
        <td>
          <div class="prod-cell">
            {% if p.image_url %}
               <a href="/dashboard/product/{{ p.product_id }}">
              <img src="{{ p.image_url }}" alt="{{ p.product }}" 
                   class="prod-thumb" loading="lazy" decoding="async">
                   </a>
            {% else %}
              <div class="prod-thumb placeholder"><i class="bi bi-image"></i></div>
            {% endif %}
            
          </div>
        </td>
        <td><div>{{ p.product }}</div></td>
        <td>
          <span class="badge bg-secondary me-1 badge-sell">Sell {{ p.sell_count }}</span>
          <span class="badge bg-success   me-1 badge-rent">Rent {{ p.rental_count }}</span>
        </td>
        <td>
          <a class="btn btn-ghost" href="/dashboard/product/{{ p.product_id }}">View</a>
        </td>
        {% set no_variants = (p.variant_count|int == 0) %}
        <td>
          <form method="post"
                action="/dashboard/product/{{ p.product_id }}/toggle-active"
                onsubmit="return {{ 'false' if no_variants else 'confirm(\'Toggle status for all variants of ' ~ p.product|e ~ '?\')' }}">
            <button class="btn btn-ghost"
                    {% if no_variants %}disabled title="Add a variant first"{% endif %}
                    style="color: {{ 'green' if p.is_active else '#e74c3c' }};">
              {{ 'Active' if p.is_active else 'Deactive' }}
            </button>
          </form>
        </td>
        <td>
          <a class="btn btn-ghost" href="/dashboard/product/{{ p.product_id }}/variants">Variants</a>
        </td>
        <td>
          <a class="btn btn-ghost" href="/dashboard/product/{{ p.product_id }}/modify">Modify</a>
        </td>
        <td>
          <button class="btn btn-ghost" style="color:#e74c3c">Delete</button>
        </td>
      </tr>
    {% endfor %}

    <!-- existing hidden empty row ... -->
  {% endif %}
</tbody>
    </table>

    <!-- Client-side pager (binds to table via data-table) -->
    <nav class="table-pager" id="productsPager" data-table=".table-products" aria-label="Products pagination">
      <button class="tp-btn tp-first"  type="button">«</button>
      <button class="tp-btn tp-prev"   type="button">‹</button>
      <span class="tp-info">Page <b class="tp-page">1</b> / <span class="tp-pages">1</span></span>
      <button class="tp-btn tp-next"   type="button">›</button>
      <button class="tp-btn tp-last"   type="button">»</button>
      <span class="tp-gap"></span>
      <label class="tp-size">Rows:
        <select class="tp-page-size">
          <option>10</option><option selected>20</option><option>30</option><option>50</option>
        </select>
      </label>
    </nav>
  </div>

  <!-- Page-scoped JS to wire the filter and keep pager in sync -->
  <script>
  (function productsFilter(){
    const tabs  = document.getElementById('jsProductTabs');
    const table = document.querySelector('.table-products');
    const tbody = table?.querySelector('tbody');
    const pager = document.getElementById('productsPager');
    if (!tabs || !table || !tbody) return;

    function visibleRowCount(){
      return Array.from(tbody.querySelectorAll('tr'))
        .filter(tr => !tr.classList.contains('js-empty') && (tr.dataset.filtered ?? "1") !== "0").length;
    }

    function toggleEmptyRow(show){
      const er = tbody.querySelector('.js-empty');
      if (er) er.style.display = show ? '' : 'none';
    }

    function apply(mode){
      // tab active state
      tabs.querySelectorAll('.seg').forEach(a => a.classList.toggle('is-active', a.dataset.filter === mode));

      // mark rows as kept/filtered (DO NOT change display here)
      const rows = Array.from(tbody.querySelectorAll('tr')).filter(tr => !tr.classList.contains('js-empty'));
      rows.forEach(tr => {
        const sell = tr.dataset.hasSell === '1';
        const rent = tr.dataset.hasRent === '1';
        let keep = true;
        if (mode === 'sell') keep = sell;
        else if (mode === 'rent') keep = rent;
        tr.dataset.filtered = keep ? '1' : '0';
      });

      // toggle badges per mode (visual only)
      table.querySelectorAll('.badge-sell').forEach(el => el.style.display = (mode === 'rent') ? 'none' : '');
      table.querySelectorAll('.badge-rent').forEach(el => el.style.display = (mode === 'sell') ? 'none' : '');

      // empty state if nothing visible
      toggleEmptyRow(visibleRowCount() === 0);

      // ask paginator to re-count & repaint current page
      if (pager && typeof pager._repaginate === 'function') pager._repaginate();
    }

    tabs.addEventListener('click', (e) => {
      const a = e.target.closest('.seg');
      if (!a) return;
      e.preventDefault();
      apply(a.dataset.filter || 'all');
    });

    // default mode
    apply('all');
  })();
</script>


{% endblock %}
